
services:
  tailscale:
    image: tailscale/tailscale:latest
    container_name: tailscale
    hostname: hackathon-server
    environment:
      - TS_AUTHKEY=tskey-auth-REDACTED-REDACTED
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
    volumes:
      - ./tailscale/state:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    restart: no
    # IMPORTANT : C'est ICI qu'on expose les ports vers l'extérieur maintenant
    ports:
      - "5432:5432" # Postgress
      - "1883:1883" # MQTT
      - "8883:8883" # MQTT TLS

  postgres:
    build: ./pg
    container_name: pg
    network_mode: "service:tailscale" # Utilise le réseau Tailscale
    environment:
      POSTGRES_USER: demo
      POSTGRES_PASSWORD: demo123
      POSTGRES_DB: maintenance
    volumes:
      - pg-data:/var/lib/postgresql/data
      - ./pg/init.sql:/docker-entrypoint-initdb.d/init.sql
    depends_on:
      - tailscale

  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: mqtt
    network_mode: "service:tailscale" # Utilise le réseau Tailscale
    volumes:
      - ./mqtt/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - ./mqtt/certs:/mosquitto/certs
    depends_on:
      - tailscale

# Les volumes restent identiques
volumes:
  pg-data:
  pg-data-backup: